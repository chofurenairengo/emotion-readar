
services:
  api:
    build:
      context: ./server
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    env_file:
      - ./.env

    environment:
      - GCP_PROJECT_ID=${GCP_PROJECT_ID:-dev-project}
      - FIRESTORE_EMULATOR_HOST=firestore-emulator:8080
      - FIRESTORE_PROJECT_ID=${FIRESTORE_PROJECT_ID:-dev-project}
      - DEV_AUTH_BYPASS=${DEV_AUTH_BYPASS:-true}
      - GOOGLE_APPLICATION_CREDENTIALS=/tmp/keys/adc.json
    depends_on:
      - firestore-emulator
    volumes:
      - ./server/app:/app/app:rw
      - ${HOME}/.config/gcloud/application_default_credentials.json:/tmp/keys/adc.json:ro
    working_dir: /app
    command: uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  firestore-emulator:
    image: node:lts-slim
    container_name: era-firestore-emulator
    ports:
      - "8080:8080"
      - "4000:4000"
    environment:
      GCLOUD_PROJECT: ${GCP_PROJECT_ID:-dev-project}
    volumes:
      - ./firebase.json:/app/firebase.json:ro
    working_dir: /app
    command: >
      sh -c "apt-get update && apt-get install -y wget apt-transport-https gpg && wget -qO - https://packages.adoptium.net/artifactory/api/gpg/key/public | gpg --dearmor -o /etc/apt/keyrings/adoptium.gpg && echo 'deb [signed-by=/etc/apt/keyrings/adoptium.gpg] https://packages.adoptium.net/artifactory/deb bookworm main' > /etc/apt/sources.list.d/adoptium.list && apt-get update && apt-get install -y temurin-21-jre && npm install -g firebase-tools && firebase emulators:start --project dev-project"
