# Issue駆動開発ワークフロー

## 自動認識パターン

以下のパターンを検出した場合、Issue駆動開発フローを自動開始する。

### コマンド形式

- `/issue #XX`
- `/issue XX`

### 自然言語形式（日本語）

- 「issue #XX を実装して」
- 「#XX の対応をお願い」
- 「issue XX に基づいて実装」
- 「XX番のissueを解決」
- 「issue #XX をやって」
- 「#XX を修正して」

### 自然言語形式（英語）

- "implement issue #XX"
- "work on #XX"
- "fix issue XX"
- "resolve #XX"

---

## フロー詳細

### Phase 1: Issue分析

```
1. gh issue view でIssue情報取得
2. issue-analyzerエージェント起動
3. 仕様の問題点を分析
4. 質問リストを生成
```

**完了条件**: 分析レポート生成完了

### Phase 2: 仕様確認

```
1. 質問がある場合: ユーザーに提示
2. 回答を受け取る
3. 回答に基づきIssue本文を更新
   gh issue edit <番号> --body "$UPDATED_BODY"
```

**完了条件**: 全質問への回答完了、またはスキップ確認

### Phase 3: worktree作成

```bash
# ブランチとworktreeを作成
git worktree add -b feature/<番号> <番号>
cd <番号>
```

**完了条件**: worktree作成成功

### Phase 4: 計画作成

```
1. plannerエージェント起動
2. 実装計画を作成
3. ユーザー確認を待つ（CRITICAL）
```

**完了条件**: ユーザーが計画を承認

### Phase 5: 仕様駆動実装

```
1. issueの仕様に基づいて実装
2. 仕様に書かれた機能のみを実装
3. 過剰な機能追加は禁止
```

**重要**:

- テスト先行（TDD）ではなく、仕様先行で実装
- issueに書かれていない機能は実装しない
- 実装判断に迷ったらユーザーに確認

**完了条件**: issueの仕様が実装完了

### Phase 6: コードレビュー

```
1. issue-code-reviewerエージェント起動
2. issueの仕様範囲内で問題を検出
3. 仕様外の改善提案はしない
```

**レビュー観点**:

- issueの要件を満たしているか
- 仕様範囲内でのバグ・問題
- 仕様範囲内でのセキュリティ問題

**完了条件**: レビューレポート生成

### Phase 7: 修正・最終化

```
1. 問題があれば修正（仕様範囲内のみ）
2. 再レビュー（必要に応じて）
3. Issue本文を最終更新
   - 実装完了状況
   - 変更ファイル一覧
```

**完了条件**: 問題なし、Issue更新完了

---

## Issue本文更新フォーマット

```markdown
[元のIssue本文はそのまま維持]

---

## 実装ログ（自動生成）

### 仕様確認 (YYYY-MM-DD)

- Q1: [質問] → A: [回答]
- Q2: [質問] → A: [回答]

### 実装計画 (YYYY-MM-DD)

- Phase 1: [概要]
- Phase 2: [概要]

### 実装完了 (YYYY-MM-DD)

- 変更ファイル: X個

### 変更ファイル一覧

- `path/to/file1.py` - [変更概要]
- `path/to/file2.py` - [変更概要]

### レビュー結果

- 問題: X件（修正済み）
- 状態: APPROVED
```

---

## 重要ルール

### 絶対厳守

1. **各issueは独立** - 他issueの成果物を前提としない
2. **仕様範囲内のみ** - issueに書かれた仕様のみを実装
3. **Issue本文は`gh issue edit`で更新** - コメントではなく本文を編集
4. **worktree使用必須** - mainブランチ直接変更禁止

### 実装の制約

1. issueに書かれていない機能は実装しない
2. 「あったほうが良い」機能を勝手に追加しない
3. リファクタリングは仕様に含まれる場合のみ
4. コメント・ドキュメント追加は仕様に含まれる場合のみ

### レビューの制約

1. issueの仕様範囲内の問題のみ指摘
2. 仕様外の改善提案はしない
3. 「こうしたほうが良い」は仕様内のみ
4. 他issueで対応すべき問題は指摘しない

### 推奨

1. 質問は最小限に抑える（重要な曖昧さのみ）
2. 計画承認前にコードを書かない
3. 小さくコミット

### 禁止

1. 他issueへの影響を与える変更
2. 計画未承認での実装開始
3. Issue本文の元内容を削除
4. 仕様外の機能追加

---

## エラーハンドリング

### Issue取得失敗

```
→ 番号を確認
→ リポジトリ権限を確認
→ ネットワーク接続を確認
```

### worktree作成失敗

```
→ 同名worktreeが存在するか確認
→ git worktree list で状態確認
→ 必要に応じて git worktree remove
```

### ビルドエラー

```
→ build-error-resolverエージェント起動
→ 最小限の修正でビルド復旧
→ フロー再開
```

---

## エージェント連携

```
issue-analyzer → planner → 仕様駆動実装 → issue-code-reviewer
     ↓              ↓           ↓                ↓
  [分析]        [計画]       [実装]           [レビュー]
     ↓              ↓           ↓                ↓
  質問生成      承認待ち    仕様のみ実装      仕様内問題検出
     ↓              ↓           ↓                ↓
  Issue更新    Issue更新   Issue更新         Issue更新
```
