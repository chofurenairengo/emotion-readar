name: Specification Change Alert

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]
    paths:
      # ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã‚’æ¤œçŸ¥
      - 'server/app/api/**'
      - 'server/app/core/**'
      - 'server/app/dto/**'
      - 'server/app/models/**'
      - 'server/app/services/**'
      - 'server/app/infra/**'

permissions:
  pull-requests: write

jobs:
  check-spec-update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if spec files were updated
        id: check-spec
        run: |
          # ä»•æ§˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          SPEC_CHANGED=$(git diff --name-only origin/main...HEAD | grep -E '^(SPECIFICATION\.md|docs/spec/)' || true)
          if [ -z "$SPEC_CHANGED" ]; then
            echo "spec_updated=false" >> $GITHUB_OUTPUT
          else
            echo "spec_updated=true" >> $GITHUB_OUTPUT
          fi

      - name: Get changed code files
        id: changed-files
        if: steps.check-spec.outputs.spec_updated == 'false'
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          CHANGED=$(git diff --name-only origin/main...HEAD | grep -E '^server/app/(api|core|dto|models|services|infra)/' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post reminder comment
        if: steps.check-spec.outputs.spec_updated == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = `${{ steps.changed-files.outputs.files }}`;
            if (!changedFiles.trim()) return;

            const body = `## ğŸ“‹ ä»•æ§˜æ›¸æ›´æ–°ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼

            ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸãŒã€ä»•æ§˜æ›¸ãŒæ›´æ–°ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

            **å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:**
            \`\`\`
            ${changedFiles}
            \`\`\`

            **ç¢ºèªäº‹é …:**
            - [ ] APIä»•æ§˜ã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆ â†’ \`docs/spec/api.md\` ã‚’æ›´æ–°
            - [ ] DTO/ãƒ¢ãƒ‡ãƒ«ã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆ â†’ \`docs/spec/models.md\` ã‚’æ›´æ–°
            - [ ] ã‚µãƒ¼ãƒ“ã‚¹ã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆ â†’ \`docs/spec/services.md\` ã‚’æ›´æ–°
            - [ ] ã‚µãƒ¼ãƒãƒ¼æ§‹æˆã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆ â†’ \`docs/spec/server.md\` ã‚’æ›´æ–°

            **ä»•æ§˜æ›¸ã®è‡ªå‹•æ›´æ–°ã‚³ãƒãƒ³ãƒ‰:**
            - Claude Code: \`/update-spec\`
            - GitHub Copilot: \`@workspace /update-spec\`

            > ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚ä»•æ§˜ã«å½±éŸ¿ã®ãªã„å¤‰æ›´ã®å ´åˆã¯ç„¡è¦–ã—ã¦ãã ã•ã„ã€‚`;

            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèª
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('ä»•æ§˜æ›¸æ›´æ–°ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼')
            );

            if (existingComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              // æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
