<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comm-XR ã‚¯ãƒ©ã‚¹é–¢é€£å›³</title>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #e0e0e0;
    }
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      text-align: center;
      padding: 30px 0;
      border-bottom: 1px solid #3a3a5a;
      margin-bottom: 30px;
    }
    h1 {
      font-size: 2.5rem;
      background: linear-gradient(90deg, #00d9ff, #00ff88);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #8888aa;
      font-size: 1.1rem;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .tab {
      padding: 12px 24px;
      background: #2a2a4a;
      border: 1px solid #4a4a6a;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.95rem;
    }
    .tab:hover {
      background: #3a3a5a;
      border-color: #00d9ff;
    }
    .tab.active {
      background: linear-gradient(135deg, #00d9ff33, #00ff8833);
      border-color: #00d9ff;
      color: #00d9ff;
    }
    .diagram-container {
      background: #0d1117;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      border: 1px solid #30363d;
      overflow-x: auto;
    }
    .diagram-section {
      display: none;
    }
    .diagram-section.active {
      display: block;
    }
    .mermaid {
      display: flex;
      justify-content: center;
    }
    .legend {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      padding: 20px;
      background: #1a1a2e;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: #2a2a4a;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      border: 1px solid #3a3a5a;
    }
    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #00d9ff;
    }
    .stat-label {
      color: #8888aa;
      font-size: 0.85rem;
      margin-top: 5px;
    }
    footer {
      text-align: center;
      padding: 20px;
      color: #6a6a8a;
      border-top: 1px solid #3a3a5a;
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Comm-XR ã‚¯ãƒ©ã‚¹é–¢é€£å›³</h1>
      <p class="subtitle">Clean Architecture ã«ã‚ˆã‚‹ Python/FastAPI ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ§‹æˆ</p>
    </header>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-number">35+</div>
        <div class="stat-label">ç·ã‚¯ãƒ©ã‚¹æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">19</div>
        <div class="stat-label">DTO</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">9</div>
        <div class="stat-label">ã‚µãƒ¼ãƒ“ã‚¹</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">5</div>
        <div class="stat-label">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">4</div>
        <div class="stat-label">ãƒ«ãƒ¼ã‚¿ãƒ¼</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">3</div>
        <div class="stat-label">ãƒªãƒã‚¸ãƒˆãƒª</div>
      </div>
    </div>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background: #ff6b6b;"></div>
        <span>Router (API Layer)</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #4ecdc4;"></div>
        <span>Service (Business Logic)</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #45b7d1;"></div>
        <span>Repository (Data Access)</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #96ceb4;"></div>
        <span>Model / DTO</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #ffeaa7;"></div>
        <span>Interface / Protocol</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #dfe6e9;"></div>
        <span>External (GCP)</span>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="overview">å…¨ä½“æ¦‚è¦</div>
      <div class="tab" data-tab="websocket">WebSocket ãƒ•ãƒ­ãƒ¼</div>
      <div class="tab" data-tab="session">ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†</div>
      <div class="tab" data-tab="services">ã‚µãƒ¼ãƒ“ã‚¹å±¤</div>
      <div class="tab" data-tab="dto">DTO æ§‹æˆ</div>
      <div class="tab" data-tab="repository">ãƒªãƒã‚¸ãƒˆãƒªå±¤</div>
      <div class="tab" data-tab="domain">ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«</div>
      <div class="tab" data-tab="usecase">ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹</div>
      <div class="tab" data-tab="android">Android</div>
      <div class="tab" data-tab="unity">Unity</div>
    </div>

    <div class="diagram-container">
      <!-- å…¨ä½“æ¦‚è¦ -->
      <div id="overview" class="diagram-section active">
        <pre class="mermaid">
%%{init: {'theme': 'dark', 'themeVariables': { 'primaryColor': '#2a2a4a', 'primaryTextColor': '#fff', 'primaryBorderColor': '#4a4a6a', 'lineColor': '#00d9ff', 'secondaryColor': '#1a1a2e'}}}%%
flowchart TB
    subgraph API["ğŸŒ API Layer"]
        HR["Health Router<br/><small>ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯</small>"]
        SR["Sessions Router<br/><small>ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ãƒ»çµ‚äº†</small>"]
        FR["Features Router<br/><small>éè¨€èªç‰¹å¾´é‡å—ä¿¡</small>"]
        RR["Realtime Router<br/><small>WebSocketé€šä¿¡</small>"]
    end

    subgraph SERVICES["âš™ï¸ Service Layer"]
        RGS["ResponseGeneratorService<br/><small>å‡¦ç†å…¨ä½“ã®çµ±æ‹¬</small>"]
        SS["SessionService<br/><small>ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†</small>"]
        LLS["LLMService<br/><small>Gemini APIå‘¼ã³å‡ºã—</small>"]
        STTS["STTService<br/><small>éŸ³å£°â†’ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›</small>"]
        CS["ConversationService<br/><small>ä¼šè©±å±¥æ­´ç®¡ç†</small>"]
        EIS["EmotionInterpreterService<br/><small>æ„Ÿæƒ…ã‚¹ã‚³ã‚¢è§£é‡ˆ</small>"]
        CM["ConnectionManager<br/><small>WebSocketæ¥ç¶šç®¡ç†</small>"]
    end

    subgraph REPOS["ğŸ’¾ Repository Layer"]
        IMSR["InMemorySessionRepository<br/><small>ãƒ¡ãƒ¢ãƒªå†…ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜</small>"]
        FSR["FirestoreSessionRepository<br/><small>Firestoreæ°¸ç¶šåŒ–</small>"]
    end

    subgraph MODELS["ğŸ“¦ Domain"]
        Session["Session<br/><small>ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±</small>"]
        FeatureLog["FeatureLog<br/><small>ç‰¹å¾´é‡ãƒ­ã‚°</small>"]
    end

    subgraph EXTERNAL["â˜ï¸ External"]
        VERTEX["Vertex AI / Gemini"]
        GCS["Google Cloud STT"]
        FS_DB[("Firestore")]
    end

    %% Main Flow (Top to Bottom)
    RR --> RGS
    RGS --> STTS & CS & EIS & LLS
    SR --> SS
    SS --> IMSR & FSR

    %% External connections
    STTS -.-> GCS
    LLS -.-> VERTEX
    FSR -.-> FS_DB

    %% Model usage
    SS --> Session
    IMSR --> Session

    classDef router fill:#ff6b6b,stroke:#ff6b6b,color:#fff
    classDef service fill:#4ecdc4,stroke:#4ecdc4,color:#000
    classDef repo fill:#45b7d1,stroke:#45b7d1,color:#000
    classDef model fill:#96ceb4,stroke:#96ceb4,color:#000
    classDef external fill:#dfe6e9,stroke:#dfe6e9,color:#000

    class HR,SR,FR,RR router
    class SS,RGS,LLS,STTS,CS,EIS,CM service
    class FSR,IMSR repo
    class Session,FeatureLog model
    class VERTEX,GCS,FS_DB external
        </pre>
      </div>

      <!-- WebSocket ãƒ•ãƒ­ãƒ¼ -->
      <div id="websocket" class="diagram-section">
        <pre class="mermaid">
%%{init: {'theme': 'dark'}}%%
sequenceDiagram
    participant C as ğŸ“± Client
    participant R as ğŸŒ Router
    participant RGS as âš™ï¸ ResponseGenerator
    participant STT as ğŸ¤ STT
    participant LLM as ğŸ¤– LLM

    C->>R: WebSocketæ¥ç¶š
    R-->>C: æ¥ç¶šç¢ºç«‹

    rect rgb(40, 40, 60)
        Note over C,LLM: åˆ†æãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†
        C->>R: ANALYSIS_REQUEST<br/>(æ„Ÿæƒ…ã‚¹ã‚³ã‚¢, éŸ³å£°)
        R->>RGS: process()
        RGS->>STT: éŸ³å£°èªè­˜
        STT-->>RGS: ãƒ†ã‚­ã‚¹ãƒˆ
        RGS->>LLM: è¿”ç­”ç”Ÿæˆ
        LLM-->>RGS: ææ¡ˆ2ä»¶
        RGS-->>R: AnalysisResponse
        R-->>C: è¿”ç­”å€™è£œãƒ»æ„Ÿæƒ…è§£é‡ˆ
    end
        </pre>
      </div>

      <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† -->
      <div id="session" class="diagram-section">
        <pre class="mermaid">
%%{init: {'theme': 'dark'}}%%
flowchart LR
    subgraph ROUTER["ğŸŒ Router"]
        SR["SessionsRouter<br/><small>ã‚»ãƒƒã‚·ãƒ§ãƒ³APIæä¾›</small>"]
    end

    subgraph SERVICE["âš™ï¸ Service"]
        SS["SessionService<br/><small>ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãƒ»çµ‚äº†ãƒ»æ¤œè¨¼</small>"]
    end

    subgraph REPO["ğŸ’¾ Repository"]
        SRP["SessionRepository<br/><small>â‰ªProtocolâ‰« æ°¸ç¶šåŒ–IF</small>"]
        IMSR["InMemorySessionRepo<br/><small>ãƒ¡ãƒ¢ãƒªä¿å­˜ï¼ˆé–‹ç™ºç”¨ï¼‰</small>"]
        FSR["FirestoreSessionRepo<br/><small>Firestoreä¿å­˜ï¼ˆæœ¬ç•ªï¼‰</small>"]
    end

    subgraph MODEL["ğŸ“¦ Model"]
        Session["Session<br/><small>id, owner_id, status, é–‹å§‹/çµ‚äº†æ—¥æ™‚</small>"]
    end

    SR --> SS
    SS --> SRP
    SRP -.-> IMSR
    SRP -.-> FSR
    IMSR --> Session
    FSR --> Session

    classDef router fill:#ff6b6b,stroke:#ff6b6b,color:#fff
    classDef service fill:#4ecdc4,stroke:#4ecdc4,color:#000
    classDef repo fill:#45b7d1,stroke:#45b7d1,color:#000
    classDef protocol fill:#ffeaa7,stroke:#ffeaa7,color:#000
    classDef model fill:#96ceb4,stroke:#96ceb4,color:#000

    class SR router
    class SS service
    class SRP protocol
    class IMSR,FSR repo
    class Session model
        </pre>
      </div>

      <!-- ã‚µãƒ¼ãƒ“ã‚¹å±¤ -->
      <div id="services" class="diagram-section">
        <pre class="mermaid">
%%{init: {'theme': 'dark'}}%%
flowchart TB
    subgraph ORCHESTRATOR["ğŸ¯ Orchestrator"]
        RGS["ResponseGeneratorService<br/><small>å‡¦ç†å…¨ä½“ã‚’çµ±æ‹¬ã—ã€å„ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‘¼ã³å‡ºã™</small>"]
    end

    subgraph CORE["âš™ï¸ Core Services"]
        STT["STTService<br/><small>Google Cloud STTã§éŸ³å£°â†’ãƒ†ã‚­ã‚¹ãƒˆ</small>"]
        CS["ConversationService<br/><small>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã®ä¼šè©±å±¥æ­´ã‚’ä¿æŒ</small>"]
        EIS["EmotionInterpreterService<br/><small>æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ã‚’äººé–“å‘ã‘è§£é‡ˆã«å¤‰æ›</small>"]
        LLM["LLMService<br/><small>Gemini APIã§è¿”ç­”å€™è£œã‚’ç”Ÿæˆ</small>"]
    end

    subgraph INFRA["ğŸ”§ Infrastructure"]
        CM["ConnectionManager<br/><small>WebSocketæ¥ç¶šã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¥ã«ç®¡ç†</small>"]
        RL["InMemoryRateLimiter<br/><small>APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’ç®¡ç†</small>"]
        SS["SessionService<br/><small>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®CRUDæ“ä½œ</small>"]
    end

    RGS --> STT
    RGS --> CS
    RGS --> EIS
    RGS --> LLM

    classDef orchestrator fill:#fd79a8,stroke:#fd79a8,color:#000
    classDef core fill:#4ecdc4,stroke:#4ecdc4,color:#000
    classDef infra fill:#74b9ff,stroke:#74b9ff,color:#000

    class RGS orchestrator
    class STT,CS,EIS,LLM core
    class CM,RL,SS infra
        </pre>
      </div>

      <!-- DTO æ§‹æˆ -->
      <div id="dto" class="diagram-section">
        <pre class="mermaid">
%%{init: {'theme': 'dark'}}%%
flowchart TB
    subgraph REQUEST["ğŸ“¥ Request DTOs"]
        AR["AnalysisRequest<br/><small>æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ãƒ»éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡</small>"]
        FR["FeatureRequest<br/><small>éè¨€èªç‰¹å¾´é‡ï¼ˆè¡¨æƒ…ãƒ»è¦–ç·šãƒ»å£°ï¼‰</small>"]
    end

    subgraph RESPONSE["ğŸ“¤ Response DTOs"]
        ARES["AnalysisResponse<br/><small>è¿”ç­”å€™è£œãƒ»æ„Ÿæƒ…è§£é‡ˆãƒ»éŸ³å£°èªè­˜çµæœ</small>"]
        FRES["FeatureResponse<br/><small>ç‰¹å¾´é‡å—ä¿¡ç¢ºèª</small>"]
    end

    subgraph CONVERSATION["ğŸ’¬ Conversation"]
        UT["Utterance<br/><small>ç™ºè©±1ä»¶ï¼ˆè©±è€…ãƒ»ãƒ†ã‚­ã‚¹ãƒˆãƒ»æ„Ÿæƒ…ï¼‰</small>"]
        EC["EmotionContext<br/><small>ç™ºè©±æ™‚ã®æ„Ÿæƒ…çŠ¶æ…‹</small>"]
        SP["Speaker<br/><small>â‰ªEnumâ‰« USER / PARTNER</small>"]
    end

    subgraph EMOTION["ğŸ˜Š Emotion"]
        EI["EmotionInterpretation<br/><small>æ„Ÿæƒ…ã®è§£é‡ˆçµæœï¼ˆå¼·åº¦ãƒ»èª¬æ˜ï¼‰</small>"]
        ECH["EmotionChange<br/><small>æ„Ÿæƒ…ã®å¤‰åŒ–æ¤œå‡º</small>"]
    end

    subgraph LLM["ğŸ¤– LLM Output"]
        LRR["LLMResponseResult<br/><small>LLMå¿œç­”ï¼ˆææ¡ˆ2ä»¶+çŠ¶æ³åˆ†æï¼‰</small>"]
        RS["ResponseSuggestion<br/><small>è¿”ç­”å€™è£œ1ä»¶ï¼ˆãƒ†ã‚­ã‚¹ãƒˆ+æ„å›³ï¼‰</small>"]
    end

    subgraph AUDIO["ğŸ¤ Audio"]
        TR["TranscriptionResult<br/><small>éŸ³å£°èªè­˜çµæœï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ»ä¿¡é ¼åº¦ï¼‰</small>"]
        AF["AudioFormat<br/><small>â‰ªEnumâ‰« WAV / OPUS / PCM</small>"]
    end

    ARES --> EI
    ARES --> TR
    ARES --> RS
    UT --> EC
    UT --> SP
    LRR --> RS

    classDef request fill:#ff7675,stroke:#ff7675,color:#fff
    classDef response fill:#00b894,stroke:#00b894,color:#fff
    classDef conversation fill:#74b9ff,stroke:#74b9ff,color:#000
    classDef emotion fill:#fdcb6e,stroke:#fdcb6e,color:#000
    classDef llm fill:#a29bfe,stroke:#a29bfe,color:#000
    classDef audio fill:#81ecec,stroke:#81ecec,color:#000

    class AR,FR request
    class ARES,FRES response
    class UT,EC,SP conversation
    class EI,ECH emotion
    class LRR,RS llm
    class TR,AF audio
        </pre>
      </div>

      <!-- ãƒªãƒã‚¸ãƒˆãƒªå±¤ -->
      <div id="repository" class="diagram-section">
        <pre class="mermaid">
%%{init: {'theme': 'dark'}}%%
flowchart LR
    subgraph PROTOCOL["ğŸ“‹ Protocol"]
        SRP["SessionRepository<br/><small>ã‚»ãƒƒã‚·ãƒ§ãƒ³æ°¸ç¶šåŒ–ã®æŠ½è±¡IF</small>"]
        CRP["ConversationRepository<br/><small>ä¼šè©±å±¥æ­´æ°¸ç¶šåŒ–ã®æŠ½è±¡IF</small>"]
    end

    subgraph MEMORY["ğŸ§ª é–‹ç™ºç”¨ï¼ˆIn-Memoryï¼‰"]
        IMS["InMemorySessionRepo<br/><small>dict ã§ãƒ¡ãƒ¢ãƒªå†…ä¿å­˜</small>"]
    end

    subgraph PROD["ğŸš€ æœ¬ç•ªç”¨ï¼ˆFirestoreï¼‰"]
        FSS["FirestoreSessionRepo<br/><small>sessions ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</small>"]
        FSC["FirestoreConversationRepo<br/><small>sessions/{id}/utterances</small>"]
    end

    subgraph DB["â˜ï¸ GCP"]
        FS[("Firestore")]
    end

    SRP -.->|å®Ÿè£…| IMS
    SRP -.->|å®Ÿè£…| FSS
    CRP -.->|å®Ÿè£…| FSC
    FSS --> FS
    FSC --> FS

    classDef protocol fill:#ffeaa7,stroke:#ffeaa7,color:#000
    classDef memory fill:#74b9ff,stroke:#74b9ff,color:#000
    classDef prod fill:#00b894,stroke:#00b894,color:#fff
    classDef db fill:#dfe6e9,stroke:#dfe6e9,color:#000

    class SRP,CRP protocol
    class IMS memory
    class FSS,FSC prod
    class FS db
        </pre>
      </div>

      <!-- ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ« -->
      <div id="domain" class="diagram-section">
        <pre class="mermaid">
%%{init: {'theme': 'dark'}}%%
flowchart TB
    subgraph SESSION_AGG["ğŸ“¦ Sessioné›†ç´„"]
        Session["Session<br/><small>id, owner_id, status<br/>started_at, ended_at</small>"]
        FeatureLog["FeatureLog<br/><small>facial, gaze, voice<br/>extras, timestamp</small>"]
        Utterance["Utterance<br/><small>speaker, text<br/>timestamp, emotion_context</small>"]
    end

    subgraph EMOTION_VO["ğŸ˜Š æ„Ÿæƒ…å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"]
        EI["EmotionInterpretation<br/><small>primary_emotion, intensity<br/>description, suggestion</small>"]
        EC["EmotionContext<br/><small>primary_emotion<br/>emotion_scores</small>"]
    end

    subgraph LLM_VO["ğŸ¤– LLMå‡ºåŠ›"]
        LRR["LLMResponseResult<br/><small>responses[2]<br/>situation_analysis</small>"]
        RS["ResponseSuggestion<br/><small>text, intent</small>"]
    end

    Session -->|1:N| FeatureLog
    Session -->|1:N| Utterance
    Utterance -->|0:1| EC
    LRR -->|1:2| RS

    classDef aggregate fill:#ff6b6b,stroke:#ff6b6b,color:#fff
    classDef vo fill:#4ecdc4,stroke:#4ecdc4,color:#000
    classDef llm fill:#a29bfe,stroke:#a29bfe,color:#000

    class Session,FeatureLog,Utterance aggregate
    class EI,EC vo
    class LRR,RS llm
        </pre>
      </div>

      <!-- ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ -->
      <div id="usecase" class="diagram-section">
        <pre class="mermaid">
%%{init: {'theme': 'dark'}}%%
flowchart LR
    subgraph ACTOR["ğŸ‘¤ ã‚¢ã‚¯ã‚¿ãƒ¼"]
        User["ãƒ¦ãƒ¼ã‚¶ãƒ¼<br/><small>Androidç«¯æœ«ã‚’è£…ç€</small>"]
        Partner["ä¼šè©±ç›¸æ‰‹<br/><small>å¯¾é¢ã®ç›¸æ‰‹</small>"]
    end

    subgraph USECASE["ğŸ“‹ ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹"]
        subgraph SESSION["ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†"]
            UC1["ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹<br/><small>ä¼šè©±æ”¯æ´ã‚’é–‹å§‹</small>"]
            UC2["ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†<br/><small>ä¼šè©±æ”¯æ´ã‚’çµ‚äº†</small>"]
        end

        subgraph FEATURE["ç‰¹å¾´é‡åé›†"]
            UC3["éè¨€èªç‰¹å¾´é‡é€ä¿¡<br/><small>è¡¨æƒ…ãƒ»è¦–ç·šãƒ»å£°ã‚’é€ä¿¡</small>"]
        end

        subgraph ANALYSIS["ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æ"]
            UC4["éŸ³å£°èªè­˜<br/><small>ç™ºè©±ã‚’ãƒ†ã‚­ã‚¹ãƒˆåŒ–</small>"]
            UC5["æ„Ÿæƒ…è§£é‡ˆ<br/><small>ç›¸æ‰‹ã®æ„Ÿæƒ…ã‚’è§£é‡ˆ</small>"]
            UC6["è¿”ç­”å€™è£œç”Ÿæˆ<br/><small>LLMã§è¿”ç­”ã‚’ææ¡ˆ</small>"]
        end

        subgraph DISPLAY["æƒ…å ±è¡¨ç¤º"]
            UC7["HUDè¡¨ç¤º<br/><small>XRã‚°ãƒ©ã‚¹ã«æƒ…å ±è¡¨ç¤º</small>"]
        end
    end

    subgraph SYSTEM["âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ "]
        SYS["Comm-XRãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰"]
    end

    User --> UC1
    User --> UC2
    User --> UC3
    Partner -.->|ç™ºè©±| UC4

    UC3 --> SYS
    UC4 --> SYS
    SYS --> UC5
    SYS --> UC6
    UC5 --> UC7
    UC6 --> UC7
    UC7 --> User

    classDef actor fill:#ff6b6b,stroke:#ff6b6b,color:#fff
    classDef usecase fill:#4ecdc4,stroke:#4ecdc4,color:#000
    classDef system fill:#45b7d1,stroke:#45b7d1,color:#000

    class User,Partner actor
    class UC1,UC2,UC3,UC4,UC5,UC6,UC7 usecase
    class SYS system
        </pre>
      </div>

      <!-- Android -->
      <div id="android" class="diagram-section">
        <pre class="mermaid">
%%{init: {'theme': 'dark'}}%%
flowchart TB
    subgraph UI["ğŸ“± UI Layer"]
        MA["MainActivity<br/><small>ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ</small>"]
        MVM["MainViewModel<br/><small>UIçŠ¶æ…‹ç®¡ç†</small>"]
    end

    subgraph DOMAIN["ğŸ¯ Domain"]
        SSU["StartSessionUseCase<br/><small>ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹</small>"]
        ESU["EndSessionUseCase<br/><small>ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†</small>"]
        SAU["SendAnalysisUseCase<br/><small>åˆ†æãƒ‡ãƒ¼ã‚¿é€ä¿¡</small>"]
    end

    subgraph DATA["ğŸ’¾ Data"]
        SR["SessionRepository<br/><small>ã‚»ãƒƒã‚·ãƒ§ãƒ³CRUD</small>"]
        API["CommXRApi<br/><small>REST API</small>"]
        WS["WebSocketClient<br/><small>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡</small>"]
    end

    subgraph FEATURE["âš¡ Feature"]
        FLA["FaceLandmarkerAnalyzer<br/><small>MediaPipeé¡”æ¤œå‡º</small>"]
        ESC["EmotionScoreCalculator<br/><small>æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ç®—å‡º</small>"]
        AR["AudioRecorder<br/><small>éŸ³å£°éŒ²éŸ³</small>"]
    end

    subgraph BRIDGE["ğŸ”— Unityé€£æº"]
        UMS["UnityMessageSender<br/><small>é¡”ãƒ‡ãƒ¼ã‚¿é€ä¿¡</small>"]
    end

    MA --> MVM
    MVM --> SSU & ESU & SAU
    SSU & ESU --> SR
    SAU --> WS
    SR --> API
    FLA --> ESC
    FLA --> UMS

    classDef ui fill:#ff6b6b,stroke:#ff6b6b,color:#fff
    classDef domain fill:#4ecdc4,stroke:#4ecdc4,color:#000
    classDef data fill:#45b7d1,stroke:#45b7d1,color:#000
    classDef feature fill:#fdcb6e,stroke:#fdcb6e,color:#000
    classDef bridge fill:#a29bfe,stroke:#a29bfe,color:#000

    class MA,MVM ui
    class SSU,ESU,SAU domain
    class SR,API,WS data
    class FLA,ESC,AR feature
    class UMS bridge
        </pre>
      </div>

      <!-- Unity -->
      <div id="unity" class="diagram-section">
        <pre class="mermaid">
%%{init: {'theme': 'dark'}}%%
flowchart TB
    subgraph NETWORK["ğŸŒ Network"]
        WSC["WebSocketClient<br/><small>ã‚µãƒ¼ãƒãƒ¼é€šä¿¡</small>"]
    end

    subgraph DATA["ğŸ“¦ Data"]
        AR["AnalysisResponse<br/><small>åˆ†æçµæœ</small>"]
        EI["EmotionInterpretation<br/><small>æ„Ÿæƒ…è§£é‡ˆ</small>"]
        RS["ResponseSuggestion<br/><small>è¿”ç­”å€™è£œ</small>"]
    end

    subgraph HUD["ğŸ–¥ï¸ HUD"]
        HC["HUDController<br/><small>HUDçµ±æ‹¬</small>"]
        ED["EmotionDisplay<br/><small>æ„Ÿæƒ…è¡¨ç¤º</small>"]
        SD["SuggestionDisplay<br/><small>è¿”ç­”è¡¨ç¤º</small>"]
    end

    subgraph FACE["ğŸ‘¤ Face"]
        FWR["FaceWebSocketReceiver<br/><small>Androidé¡”ãƒ‡ãƒ¼ã‚¿å—ä¿¡</small>"]
    end

    WSC --> AR
    AR --> EI & RS
    AR --> HC
    HC --> ED & SD

    classDef network fill:#45b7d1,stroke:#45b7d1,color:#000
    classDef data fill:#96ceb4,stroke:#96ceb4,color:#000
    classDef hud fill:#ff6b6b,stroke:#ff6b6b,color:#fff
    classDef face fill:#fdcb6e,stroke:#fdcb6e,color:#000

    class WSC network
    class AR,EI,RS data
    class HC,ED,SD hud
    class FWR face
        </pre>
      </div>
    </div>

    <footer>
      <p>Generated for Comm-XR Project | Clean Architecture Overview</p>
    </footer>
  </div>

  <script>
    // Initialize Mermaid
    mermaid.initialize({
      startOnLoad: true,
      theme: 'dark',
      securityLevel: 'loose',
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true,
        curve: 'basis'
      }
    });

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs and sections
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.diagram-section').forEach(s => s.classList.remove('active'));

        // Add active class to clicked tab and corresponding section
        tab.classList.add('active');
        const sectionId = tab.getAttribute('data-tab');
        document.getElementById(sectionId).classList.add('active');
      });
    });
  </script>
</body>
</html>
